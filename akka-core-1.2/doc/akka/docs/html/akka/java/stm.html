


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Software Transactional Memory (Java) &mdash; Akka Documentation</title>
    <link rel="stylesheet" href="../_static/akka.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/print.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/theme_extras.js"></script>
    <link rel="top" title="Akka Documentation" href="../index.html" />
    <link rel="up" title="Java API" href="index.html" />
    <link rel="next" title="Transactors (Java)" href="transactors.html" />
    <link rel="prev" title="Dataflow Concurrency (Java)" href="dataflow.html" /> 
  </head>
  <body>
      <div class="header"><a href="../index.html"><img class="leftlogo" src="../_static/logo.png" alt="Logo"/></a><h1 class="heading"><a href="../index.html"><span>Akka Documentation</span></a></h1>
       <h2 class="heading"><a href="../index.html"><span>Version 1.2</span></a></h2>
       <h2 class="rightheading"><span><a href="http://akka.io/docs/akka/snapshot/Akka.pdf">PDF</a></span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="dataflow.html">Dataflow Concurrency (Java)</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="transactors.html">Transactors (Java)</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="software-transactional-memory-java">
<span id="stm-java"></span><h1>Software Transactional Memory (Java)<a class="headerlink" href="#software-transactional-memory-java" title="Permalink to this headline">¶</a></h1>
<div class="sidebar">
<p class="first sidebar-title">Contents</p>
<div class="contents local last topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#overview-of-stm" id="id1">Overview of STM</a></li>
<li><a class="reference internal" href="#simple-example" id="id2">Simple example</a></li>
<li><a class="reference internal" href="#ref" id="id3">Ref</a><ul>
<li><a class="reference internal" href="#creating-a-ref" id="id4">Creating a Ref</a></li>
<li><a class="reference internal" href="#accessing-the-value-of-a-ref" id="id5">Accessing the value of a Ref</a></li>
<li><a class="reference internal" href="#changing-the-value-of-a-ref" id="id6">Changing the value of a Ref</a></li>
</ul>
</li>
<li><a class="reference internal" href="#transactions" id="id7">Transactions</a><ul>
<li><a class="reference internal" href="#retries" id="id8">Retries</a></li>
<li><a class="reference internal" href="#unexpected-retries" id="id9">Unexpected retries</a></li>
<li><a class="reference internal" href="#coordinated-transactions-and-transactors" id="id10">Coordinated transactions and Transactors</a></li>
<li><a class="reference internal" href="#configuring-transactions" id="id11">Configuring transactions</a></li>
<li><a class="reference internal" href="#transaction-lifecycle-listeners" id="id12">Transaction lifecycle listeners</a></li>
<li><a class="reference internal" href="#blocking-transactions" id="id13">Blocking transactions</a></li>
<li><a class="reference internal" href="#alternative-blocking-transactions" id="id14">Alternative blocking transactions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#transactional-datastructures" id="id15">Transactional datastructures</a></li>
<li><a class="reference internal" href="#persistent-datastructures" id="id16">Persistent datastructures</a></li>
</ul>
</div>
</div>
<p>Module stability: <strong>SOLID</strong></p>
<div class="section" id="overview-of-stm">
<h2><a class="toc-backref" href="#id1">Overview of STM</a><a class="headerlink" href="#overview-of-stm" title="Permalink to this headline">¶</a></h2>
<p>An <a class="reference external" href="http://en.wikipedia.org/wiki/Software_transactional_memory">STM</a> turns the Java heap into a transactional data set with begin/commit/rollback semantics. Very much like a regular database. It implements the first three letters in ACID; ACI:
* (failure) Atomicity: all changes during the execution of a transaction make it, or none make it. This only counts for transactional datastructures.
* Consistency: a transaction gets a consistent of reality (in Akka you get the Oracle version of the SERIALIZED isolation level).
* Isolated: changes made by concurrent execution transactions are not visible to each other.</p>
<p>Generally, the STM is not needed that often when working with Akka. Some use-cases (that we can think of) are:</p>
<ul class="simple">
<li>When you really need composable message flows across many actors updating their <strong>internal local</strong> state but need them to do that atomically in one big transaction. Might not often, but when you do need this then you are screwed without it.</li>
<li>When you want to share a datastructure across actors.</li>
<li>When you need to use the persistence modules.</li>
</ul>
<p>Akka’s STM implements the concept in <a class="reference external" href="http://clojure.org/">Clojure’s</a> STM view on state in general. Please take the time to read <a class="reference external" href="http://clojure.org/state">this excellent document</a> and view <a class="reference external" href="http://www.infoq.com/presentations/Value-Identity-State-Rich-Hickey">this presentation</a> by Rich Hickey (the genius behind Clojure), since it forms the basis of Akka’s view on STM and state in general.</p>
<p>The STM is based on Transactional References (referred to as Refs). Refs are memory cells, holding an (arbitrary) immutable value, that implement CAS (Compare-And-Swap) semantics and are managed and enforced by the STM for coordinated changes across many Refs. They are implemented using the excellent <a class="reference external" href="http://multiverse.codehaus.org/overview.html">Multiverse STM</a>.</p>
<p>Working with immutable collections can sometimes give bad performance due to extensive copying. Scala provides so-called persistent datastructures which makes working with immutable collections fast. They are immutable but with constant time access and modification. The use of structural sharing and an insert or update does not ruin the old structure, hence “persistent”. Makes working with immutable composite types fast. The persistent datastructures currently consist of a Map and Vector.</p>
</div>
<div class="section" id="simple-example">
<h2><a class="toc-backref" href="#id2">Simple example</a><a class="headerlink" href="#simple-example" title="Permalink to this headline">¶</a></h2>
<p>Here is a simple example of an incremental counter using STM. This shows creating a <tt class="docutils literal"><span class="pre">Ref</span></tt>, a transactional reference, and then modifying it within a transaction, which is delimited by an <tt class="docutils literal"><span class="pre">Atomic</span></tt> anonymous inner class.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">akka.stm.*</span><span class="o">;</span>

<span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span><span class="mi">0</span><span class="o">);</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="nf">counter</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Atomic</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">inc</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
            <span class="n">ref</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">inc</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">inc</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
<span class="o">}</span>

<span class="n">counter</span><span class="o">();</span>
<span class="c1">// -&gt; 1</span>

<span class="n">counter</span><span class="o">();</span>
<span class="c1">// -&gt; 2</span>
</pre></div>
</div>
</div>
<div class="section" id="ref">
<h2><a class="toc-backref" href="#id3">Ref</a><a class="headerlink" href="#ref" title="Permalink to this headline">¶</a></h2>
<p>Refs (transactional references) are mutable references to values and through the STM allow the safe sharing of mutable data. To ensure safety the value stored in a Ref should be immutable. The value referenced by a Ref can only be accessed or swapped within a transaction. Refs separate identity from value.</p>
<div class="section" id="creating-a-ref">
<h3><a class="toc-backref" href="#id4">Creating a Ref</a><a class="headerlink" href="#creating-a-ref" title="Permalink to this headline">¶</a></h3>
<p>You can create a Ref with or without an initial value.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">akka.stm.*</span><span class="o">;</span>

<span class="c1">// giving an initial value</span>
<span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span><span class="mi">0</span><span class="o">);</span>

<span class="c1">// specifying a type but no initial value</span>
<span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;();</span>
</pre></div>
</div>
</div>
<div class="section" id="accessing-the-value-of-a-ref">
<h3><a class="toc-backref" href="#id5">Accessing the value of a Ref</a><a class="headerlink" href="#accessing-the-value-of-a-ref" title="Permalink to this headline">¶</a></h3>
<p>Use <tt class="docutils literal"><span class="pre">get</span></tt> to access the value of a Ref. Note that if no initial value has been given then the value is initially <tt class="docutils literal"><span class="pre">null</span></tt>.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">akka.stm.*</span><span class="o">;</span>

<span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span><span class="mi">0</span><span class="o">);</span>

<span class="n">Integer</span> <span class="n">value</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Atomic</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ref</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
<span class="c1">// -&gt; value = 0</span>
</pre></div>
</div>
</div>
<div class="section" id="changing-the-value-of-a-ref">
<h3><a class="toc-backref" href="#id6">Changing the value of a Ref</a><a class="headerlink" href="#changing-the-value-of-a-ref" title="Permalink to this headline">¶</a></h3>
<p>To set a new value for a Ref you can use <tt class="docutils literal"><span class="pre">set</span></tt> (or equivalently <tt class="docutils literal"><span class="pre">swap</span></tt>), which sets the new value and returns the old value.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">akka.stm.*</span><span class="o">;</span>

<span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span><span class="mi">0</span><span class="o">);</span>

<span class="k">new</span> <span class="nf">Atomic</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ref</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="transactions">
<h2><a class="toc-backref" href="#id7">Transactions</a><a class="headerlink" href="#transactions" title="Permalink to this headline">¶</a></h2>
<p>A transaction is delimited using an <tt class="docutils literal"><span class="pre">Atomic</span></tt> anonymous inner class.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="k">new</span> <span class="nf">Atomic</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>
<span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
</pre></div>
</div>
<p>All changes made to transactional objects are isolated from other changes, all make it or non make it (so failure atomicity) and are consistent. With the AkkaSTM you automatically have the Oracle version of the SERIALIZED isolation level, lower isolation is not possible. To make it fully serialized, set the writeskew property that checks if a writeskew problem is allowed to happen.</p>
<div class="section" id="retries">
<h3><a class="toc-backref" href="#id8">Retries</a><a class="headerlink" href="#retries" title="Permalink to this headline">¶</a></h3>
<p>A transaction is automatically retried when it runs into some read or write conflict, until the operation completes, an exception (throwable) is thrown or when there are too many retries. When a read or writeconflict is encountered, the transaction uses a bounded exponential backoff to prevent cause more contention and give other transactions some room to complete.</p>
<p>If you are using non transactional resources in an atomic block, there could be problems because a transaction can be retried. If you are using print statements or logging, it could be that they are called more than once. So you need to be prepared to deal with this. One of the possible solutions is to work with a deferred or compensating task that is executed after the transaction aborts or commits.</p>
</div>
<div class="section" id="unexpected-retries">
<h3><a class="toc-backref" href="#id9">Unexpected retries</a><a class="headerlink" href="#unexpected-retries" title="Permalink to this headline">¶</a></h3>
<p>It can happen for the first few executions that you get a few failures of execution that lead to unexpected retries, even though there is not any read or writeconflict. The cause of this is that speculative transaction configuration/selection is used. There are transactions optimized for a single transactional object, for 1..n and for n to unlimited. So based on the execution of the transaction, the system learns; it begins with a cheap one and upgrades to more expensive ones. Once it has learned, it will reuse this knowledge. It can be activated/deactivated using the speculative property on the TransactionFactoryBuilder. In most cases it is best use the default value (enabled) so you get more out of performance.</p>
</div>
<div class="section" id="coordinated-transactions-and-transactors">
<h3><a class="toc-backref" href="#id10">Coordinated transactions and Transactors</a><a class="headerlink" href="#coordinated-transactions-and-transactors" title="Permalink to this headline">¶</a></h3>
<p>If you need coordinated transactions across actors or threads then see <a class="reference internal" href="transactors.html#transactors-java"><em>Transactors (Java)</em></a>.</p>
</div>
<div class="section" id="configuring-transactions">
<h3><a class="toc-backref" href="#id11">Configuring transactions</a><a class="headerlink" href="#configuring-transactions" title="Permalink to this headline">¶</a></h3>
<p>It&#8217;s possible to configure transactions. The <tt class="docutils literal"><span class="pre">Atomic</span></tt> class can take a <tt class="docutils literal"><span class="pre">TransactionFactory</span></tt>, which can determine properties of the transaction. A default transaction factory is used if none is specified. You can create a <tt class="docutils literal"><span class="pre">TransactionFactory</span></tt> with a <tt class="docutils literal"><span class="pre">TransactionFactoryBuilder</span></tt>.</p>
<p>Configuring transactions with a <tt class="docutils literal"><span class="pre">TransactionFactory</span></tt>:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">akka.stm.*</span><span class="o">;</span>

<span class="n">TransactionFactory</span> <span class="n">txFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransactionFactoryBuilder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">setReadonly</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="k">new</span> <span class="n">Atomic</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;(</span><span class="n">txFactory</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// read only transaction</span>
        <span class="k">return</span> <span class="o">...;</span>
    <span class="o">}</span>
<span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
</pre></div>
</div>
<p>The following settings are possible on a TransactionFactory:</p>
<ul class="simple">
<li>familyName - Family name for transactions. Useful for debugging because the familyName is shown in exceptions, logging and in the future also will be used for profiling.</li>
<li>readonly - Sets transaction as readonly. Readonly transactions are cheaper and can be used to prevent modification to transactional objects.</li>
<li>maxRetries - The maximum number of times a transaction will retry.</li>
<li>timeout - The maximum time a transaction will block for.</li>
<li>trackReads - Whether all reads should be tracked. Needed for blocking operations. Readtracking makes a transaction more expensive, but makes subsequent reads cheaper and also lowers the chance of a readconflict.</li>
<li>writeSkew - Whether writeskew is allowed. Disable with care.</li>
<li>blockingAllowed - Whether explicit retries are allowed.</li>
<li>interruptible - Whether a blocking transaction can be interrupted if it is blocked.</li>
<li>speculative - Whether speculative configuration should be enabled.</li>
<li>quickRelease - Whether locks should be released as quickly as possible (before whole commit).</li>
<li>propagation - For controlling how nested transactions behave.</li>
<li>traceLevel - Transaction trace level.</li>
</ul>
<p>You can also specify the default values for some of these options in akka.conf. Here they are with their default values:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">stm</span> <span class="o">{</span>
  <span class="n">fair</span>             <span class="k">=</span> <span class="n">on</span>     <span class="k">#</span> <span class="nc">Should</span> <span class="n">global</span> <span class="n">transactions</span> <span class="n">be</span> <span class="n">fair</span> <span class="n">or</span> <span class="n">non</span><span class="o">-</span><span class="n">fair</span> <span class="o">(</span><span class="n">non</span> <span class="n">fair</span> <span class="k">yield</span> <span class="n">better</span> <span class="n">performance</span><span class="o">)</span>
  <span class="n">max</span><span class="o">-</span><span class="n">retries</span>      <span class="k">=</span> <span class="mi">1000</span>
  <span class="n">timeout</span>          <span class="k">=</span> <span class="mi">5</span>      <span class="k">#</span> <span class="nc">Default</span> <span class="n">timeout</span> <span class="k">for</span> <span class="n">blocking</span> <span class="n">transactions</span> <span class="n">and</span> <span class="n">transaction</span> <span class="n">set</span> <span class="o">(</span><span class="n">in</span> <span class="n">unit</span> <span class="n">defined</span> <span class="n">by</span>
                            <span class="k">#</span>     <span class="n">the</span> <span class="n">time</span><span class="o">-</span><span class="n">unit</span> <span class="n">property</span><span class="o">)</span>
  <span class="n">write</span><span class="o">-</span><span class="n">skew</span>       <span class="k">=</span> <span class="kc">true</span>
  <span class="n">blocking</span><span class="o">-</span><span class="n">allowed</span> <span class="k">=</span> <span class="kc">false</span>
  <span class="n">interruptible</span>    <span class="k">=</span> <span class="kc">false</span>
  <span class="n">speculative</span>      <span class="k">=</span> <span class="kc">true</span>
  <span class="n">quick</span><span class="o">-</span><span class="n">release</span>    <span class="k">=</span> <span class="kc">true</span>
  <span class="n">propagation</span>      <span class="k">=</span> <span class="s">&quot;requires&quot;</span>
  <span class="n">trace</span><span class="o">-</span><span class="n">level</span>      <span class="k">=</span> <span class="s">&quot;none&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="transaction-lifecycle-listeners">
<h3><a class="toc-backref" href="#id12">Transaction lifecycle listeners</a><a class="headerlink" href="#transaction-lifecycle-listeners" title="Permalink to this headline">¶</a></h3>
<p>It&#8217;s possible to have code that will only run on the successful commit of a transaction, or when a transaction aborts. You can do this by adding <tt class="docutils literal"><span class="pre">deferred</span></tt> or <tt class="docutils literal"><span class="pre">compensating</span></tt> blocks to a transaction.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">akka.stm.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">akka</span><span class="o">.</span><span class="na">stm</span><span class="o">.</span><span class="na">StmUtils</span><span class="o">.</span><span class="na">deferred</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">akka</span><span class="o">.</span><span class="na">stm</span><span class="o">.</span><span class="na">StmUtils</span><span class="o">.</span><span class="na">compensating</span><span class="o">;</span>

<span class="k">new</span> <span class="nf">Atomic</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">deferred</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="c1">// executes when transaction commits</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">compensating</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="c1">// executes when transaction aborts</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="c1">// ...</span>
        <span class="k">return</span> <span class="n">something</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
</pre></div>
</div>
</div>
<div class="section" id="blocking-transactions">
<h3><a class="toc-backref" href="#id13">Blocking transactions</a><a class="headerlink" href="#blocking-transactions" title="Permalink to this headline">¶</a></h3>
<p>You can block in a transaction until a condition is met by using an explicit <tt class="docutils literal"><span class="pre">retry</span></tt>. To use <tt class="docutils literal"><span class="pre">retry</span></tt> you also need to configure the transaction to allow explicit retries.</p>
<p>Here is an example of using <tt class="docutils literal"><span class="pre">retry</span></tt> to block until an account has enough money for a withdrawal. This is also an example of using actors and STM together.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">akka.stm.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Transfer</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">from</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">to</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">double</span> <span class="n">amount</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Transfer</span><span class="o">(</span><span class="n">Ref</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">from</span><span class="o">,</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">to</span><span class="o">,</span> <span class="kt">double</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">from</span> <span class="o">=</span> <span class="n">from</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">to</span> <span class="o">=</span> <span class="n">to</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">amount</span> <span class="o">=</span> <span class="n">amount</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">getFrom</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">from</span><span class="o">;</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">getTo</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">to</span><span class="o">;</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">double</span> <span class="nf">getAmount</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">amount</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">akka.stm.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">akka</span><span class="o">.</span><span class="na">stm</span><span class="o">.</span><span class="na">StmUtils</span><span class="o">.</span><span class="na">retry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.util.FiniteDuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.event.EventHandler</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Transferer</span> <span class="kd">extends</span> <span class="n">UntypedActor</span> <span class="o">{</span>
    <span class="n">TransactionFactory</span> <span class="n">txFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransactionFactoryBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">setBlockingAllowed</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setTrackReads</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setTimeout</span><span class="o">(</span><span class="k">new</span> <span class="n">FiniteDuration</span><span class="o">(</span><span class="mi">60</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Object</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="k">instanceof</span> <span class="n">Transfer</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Transfer</span> <span class="n">transfer</span> <span class="o">=</span> <span class="o">(</span><span class="n">Transfer</span><span class="o">)</span> <span class="n">message</span><span class="o">;</span>
            <span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">from</span> <span class="o">=</span> <span class="n">transfer</span><span class="o">.</span><span class="na">getFrom</span><span class="o">();</span>
            <span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">to</span> <span class="o">=</span> <span class="n">transfer</span><span class="o">.</span><span class="na">getTo</span><span class="o">();</span>
            <span class="kd">final</span> <span class="kt">double</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">transfer</span><span class="o">.</span><span class="na">getAmount</span><span class="o">();</span>
            <span class="k">new</span> <span class="nf">Atomic</span><span class="o">(</span><span class="n">txFactory</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">public</span> <span class="n">Object</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">EventHandler</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">&quot;not enough money - retrying&quot;</span><span class="o">);</span>
                        <span class="n">retry</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="n">EventHandler</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">&quot;transferring&quot;</span><span class="o">);</span>
                    <span class="n">from</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">-</span> <span class="n">amount</span><span class="o">);</span>
                    <span class="n">to</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">to</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="n">amount</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">akka.stm.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">...</span><span class="na">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">account1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;(</span><span class="mf">100.0</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">account2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;(</span><span class="mf">100.0</span><span class="o">);</span>

    <span class="n">ActorRef</span> <span class="n">transferer</span> <span class="o">=</span> <span class="n">Actors</span><span class="o">.</span><span class="na">actorOf</span><span class="o">(</span><span class="n">Transferer</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>

    <span class="n">transferer</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">Transfer</span><span class="o">(</span><span class="n">account1</span><span class="o">,</span> <span class="n">account2</span><span class="o">,</span> <span class="mf">500.0</span><span class="o">));</span>
    <span class="c1">// Transferer: not enough money - retrying</span>

    <span class="k">new</span> <span class="nf">Atomic</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">account1</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">account1</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="mi">2000</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
    <span class="c1">// Transferer: transferring</span>

    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>

    <span class="n">Double</span> <span class="n">acc1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Atomic</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="n">Double</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">account1</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}.</span><span class="na">execute</span><span class="o">();</span>

    <span class="n">Double</span> <span class="n">acc2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Atomic</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="n">Double</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">account2</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}.</span><span class="na">execute</span><span class="o">();</span>



    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Account 1: &quot;</span> <span class="o">+</span> <span class="n">acc1</span><span class="o">);</span>
    <span class="c1">// Account 1: 1600.0</span>

    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Account 2: &quot;</span> <span class="o">+</span> <span class="n">acc2</span><span class="o">);</span>
    <span class="c1">// Account 2: 600.0</span>

    <span class="n">transferer</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="alternative-blocking-transactions">
<h3><a class="toc-backref" href="#id14">Alternative blocking transactions</a><a class="headerlink" href="#alternative-blocking-transactions" title="Permalink to this headline">¶</a></h3>
<p>You can also have two alternative blocking transactions, one of which can succeed first, with <tt class="docutils literal"><span class="pre">EitherOrElse</span></tt>.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">akka.stm.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Branch</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">left</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">right</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">double</span> <span class="n">amount</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Branch</span><span class="o">(</span><span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">left</span><span class="o">,</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">right</span><span class="o">,</span> <span class="kt">int</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">left</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">right</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">amount</span> <span class="o">=</span> <span class="n">amount</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">getLeft</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">left</span><span class="o">;</span> <span class="o">}</span>

  <span class="kd">public</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">getRight</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">right</span><span class="o">;</span> <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">double</span> <span class="nf">getAmount</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">amount</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">akka.actor.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.stm.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">akka</span><span class="o">.</span><span class="na">stm</span><span class="o">.</span><span class="na">StmUtils</span><span class="o">.</span><span class="na">retry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.util.FiniteDuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.event.EventHandler</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Brancher</span> <span class="kd">extends</span> <span class="n">UntypedActor</span> <span class="o">{</span>
    <span class="n">TransactionFactory</span> <span class="n">txFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransactionFactoryBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">setBlockingAllowed</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setTrackReads</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setTimeout</span><span class="o">(</span><span class="k">new</span> <span class="n">FiniteDuration</span><span class="o">(</span><span class="mi">60</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Object</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="k">instanceof</span> <span class="n">Branch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Branch</span> <span class="n">branch</span> <span class="o">=</span> <span class="o">(</span><span class="n">Branch</span><span class="o">)</span> <span class="n">message</span><span class="o">;</span>
            <span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">left</span> <span class="o">=</span> <span class="n">branch</span><span class="o">.</span><span class="na">getLeft</span><span class="o">();</span>
            <span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">right</span> <span class="o">=</span> <span class="n">branch</span><span class="o">.</span><span class="na">getRight</span><span class="o">();</span>
            <span class="kd">final</span> <span class="kt">double</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">branch</span><span class="o">.</span><span class="na">getAmount</span><span class="o">();</span>
            <span class="k">new</span> <span class="n">Atomic</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span><span class="n">txFactory</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="n">EitherOrElse</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;()</span> <span class="o">{</span>
                        <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">either</span><span class="o">()</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">left</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">EventHandler</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">&quot;not enough on left - retrying&quot;</span><span class="o">);</span>
                                <span class="n">retry</span><span class="o">();</span>
                            <span class="o">}</span>
                            <span class="n">EventHandler</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">&quot;going left&quot;</span><span class="o">);</span>
                            <span class="k">return</span> <span class="n">left</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
                        <span class="o">}</span>
                        <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">orElse</span><span class="o">()</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">right</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">EventHandler</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">&quot;not enough on right - retrying&quot;</span><span class="o">);</span>
                                <span class="n">retry</span><span class="o">();</span>
                            <span class="o">}</span>
                            <span class="n">EventHandler</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">&quot;going right&quot;</span><span class="o">);</span>
                            <span class="k">return</span> <span class="n">right</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">akka.stm.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main2</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">...</span><span class="na">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">left</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span><span class="mi">100</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">right</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span><span class="mi">100</span><span class="o">);</span>

    <span class="n">ActorRef</span> <span class="n">brancher</span> <span class="o">=</span> <span class="n">Actors</span><span class="o">.</span><span class="na">actorOf</span><span class="o">(</span><span class="n">Brancher</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>

    <span class="n">brancher</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">Branch</span><span class="o">(</span><span class="n">left</span><span class="o">,</span> <span class="n">right</span><span class="o">,</span> <span class="mi">500</span><span class="o">));</span>
    <span class="c1">// not enough on left - retrying</span>
    <span class="c1">// not enough on right - retrying</span>

    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>

    <span class="k">new</span> <span class="nf">Atomic</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">right</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">right</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
    <span class="c1">// going right</span>



    <span class="n">brancher</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="transactional-datastructures">
<h2><a class="toc-backref" href="#id15">Transactional datastructures</a><a class="headerlink" href="#transactional-datastructures" title="Permalink to this headline">¶</a></h2>
<p>Akka provides two datastructures that are managed by the STM.</p>
<ul class="simple">
<li>TransactionalMap</li>
<li>TransactionalVector</li>
</ul>
<p>TransactionalMap and TransactionalVector look like regular mutable datastructures, they even implement the standard Scala &#8216;Map&#8217; and &#8216;RandomAccessSeq&#8217; interfaces, but they are implemented using persistent datastructures and managed references under the hood. Therefore they are safe to use in a concurrent environment. Underlying TransactionalMap is HashMap, an immutable Map but with near constant time access and modification operations. Similarly TransactionalVector uses a persistent Vector. See the Persistent Datastructures section below for more details.</p>
<p>Like managed references, TransactionalMap and TransactionalVector can only be modified inside the scope of an STM transaction.</p>
<p>Here is an example of creating and accessing a TransactionalMap:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">akka.stm.*</span><span class="o">;</span>

<span class="c1">// assuming a User class</span>

<span class="kd">final</span> <span class="n">TransactionalMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransactionalMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;();</span>

<span class="c1">// fill users map (in a transaction)</span>
<span class="k">new</span> <span class="nf">Atomic</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">users</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;bill&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="s">&quot;bill&quot;</span><span class="o">));</span>
        <span class="n">users</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;mary&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="s">&quot;mary&quot;</span><span class="o">));</span>
        <span class="n">users</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;john&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="s">&quot;john&quot;</span><span class="o">));</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}.</span><span class="na">execute</span><span class="o">();</span>

<span class="c1">// access users map (in a transaction)</span>
<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Atomic</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;bill&quot;</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
</pre></div>
</div>
<p>Here is an example of creating and accessing a TransactionalVector:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">akka.stm.*</span><span class="o">;</span>

<span class="c1">// assuming an Address class</span>

<span class="kd">final</span> <span class="n">TransactionalVector</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransactionalVector</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;();</span>

<span class="c1">// fill addresses vector (in a transaction)</span>
<span class="k">new</span> <span class="nf">Atomic</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">addresses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Address</span><span class="o">(</span><span class="s">&quot;somewhere&quot;</span><span class="o">));</span>
        <span class="n">addresses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Address</span><span class="o">(</span><span class="s">&quot;somewhere else&quot;</span><span class="o">));</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}.</span><span class="na">execute</span><span class="o">();</span>

<span class="c1">// access addresses vector (in a transaction)</span>
<span class="n">Address</span> <span class="n">address</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Atomic</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Address</span> <span class="nf">atomically</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">addresses</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
</pre></div>
</div>
</div>
<div class="section" id="persistent-datastructures">
<h2><a class="toc-backref" href="#id16">Persistent datastructures</a><a class="headerlink" href="#persistent-datastructures" title="Permalink to this headline">¶</a></h2>
<p>Akka&#8217;s STM should only be used with immutable data. This can be costly if you have large datastructures and are using a naive copy-on-write. In order to make working with immutable datastructures fast enough Scala provides what are called Persistent Datastructures. There are currently two different ones:</p>
<ul class="simple">
<li>HashMap (<a class="reference external" href="http://www.scala-lang.org/api/current/scala/collection/immutable/HashMap.html">scaladoc</a>)</li>
<li>Vector (<a class="reference external" href="http://www.scala-lang.org/api/current/scala/collection/immutable/Vector.html">scaladoc</a>)</li>
</ul>
<p>They are immutable and each update creates a completely new version but they are using clever structural sharing in order to make them almost as fast, for both read and update, as regular mutable datastructures.</p>
<p>This illustration is taken from Rich Hickey&#8217;s presentation. Copyright Rich Hickey 2009.</p>
<img alt="../_images/clojure-trees.png" src="../_images/clojure-trees.png" />
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="dataflow.html">Dataflow Concurrency (Java)</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="transactors.html">Transactors (Java)</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2011, Typesafe Inc.
      Last updated on Sep 19, 2011.
    </div>
  </body>
</html>