


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Fault Tolerance Through Supervisor Hierarchies (Scala) &mdash; Akka Documentation</title>
    <link rel="stylesheet" href="../_static/akka.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/print.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/theme_extras.js"></script>
    <link rel="top" title="Akka Documentation" href="../index.html" />
    <link rel="up" title="Scala API" href="index.html" />
    <link rel="next" title="Dispatchers (Scala)" href="dispatchers.html" />
    <link rel="prev" title="Serialization (Scala)" href="serialization.html" /> 
  </head>
  <body>
      <div class="header"><a href="../index.html"><img class="leftlogo" src="../_static/logo.png" alt="Logo"/></a><h1 class="heading"><a href="../index.html"><span>Akka Documentation</span></a></h1>
       <h2 class="heading"><a href="../index.html"><span>Version 1.2</span></a></h2>
       <h2 class="rightheading"><span><a href="http://akka.io/docs/akka/snapshot/Akka.pdf">PDF</a></span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="serialization.html">Serialization (Scala)</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="dispatchers.html">Dispatchers (Scala)</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="fault-tolerance-through-supervisor-hierarchies-scala">
<span id="fault-tolerance-scala"></span><h1>Fault Tolerance Through Supervisor Hierarchies (Scala)<a class="headerlink" href="#fault-tolerance-through-supervisor-hierarchies-scala" title="Permalink to this headline">¶</a></h1>
<div class="sidebar">
<p class="first sidebar-title">Contents</p>
<div class="contents local last topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#concurrency" id="id3">Concurrency</a></li>
<li><a class="reference internal" href="#distributed-actors" id="id4">Distributed actors</a></li>
<li><a class="reference internal" href="#supervision" id="id5">Supervision</a><ul>
<li><a class="reference internal" href="#oneforone" id="id6">OneForOne</a></li>
<li><a class="reference internal" href="#allforone" id="id7">AllForOne</a></li>
<li><a class="reference internal" href="#restart-callbacks" id="id8">Restart callbacks</a></li>
<li><a class="reference internal" href="#defining-a-supervisor-s-restart-strategy" id="id9">Defining a supervisor&#8217;s restart strategy</a></li>
<li><a class="reference internal" href="#defining-actor-life-cycle" id="id10">Defining actor life-cycle</a></li>
</ul>
</li>
<li><a class="reference internal" href="#supervising-actors" id="id11">Supervising Actors</a><ul>
<li><a class="reference internal" href="#declarative-supervisor-configuration" id="id12">Declarative supervisor configuration</a></li>
<li><a class="reference internal" href="#declaratively-define-actors-as-remote-services" id="id13">Declaratively define actors as remote services</a></li>
<li><a class="reference internal" href="#programmatic-linking-and-supervision-of-actors" id="id14">Programmatic linking and supervision of Actors</a></li>
<li><a class="reference internal" href="#the-supervising-actor-s-side-of-things" id="id15">The supervising actor&#8217;s side of things</a></li>
<li><a class="reference internal" href="#the-supervised-actor-s-side-of-things" id="id16">The supervised actor&#8217;s side of things</a></li>
<li><a class="reference internal" href="#reply-to-initial-senders" id="id17">Reply to initial senders</a></li>
<li><a class="reference internal" href="#handling-too-many-actor-restarts-within-a-specific-time-limit" id="id18">Handling too many actor restarts within a specific time limit</a></li>
</ul>
</li>
<li><a class="reference internal" href="#supervising-typed-actors" id="id19">Supervising Typed Actors</a><ul>
<li><a class="reference internal" href="#id1" id="id20">Declarative supervisor configuration</a></li>
<li><a class="reference internal" href="#id2" id="id21">Restart callbacks</a></li>
<li><a class="reference internal" href="#programatic-linking-and-supervision-of-typedactors" id="id22">Programatic linking and supervision of TypedActors</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>Module stability: <strong>SOLID</strong></p>
<p>The &#8220;let it crash&#8221; approach to fault/error handling, implemented by linking actors, is very different to what Java and most non-concurrency oriented languages/frameworks have adopted. It&#8217;s a way of dealing with failure that is designed for concurrent and distributed systems.</p>
<div class="section" id="concurrency">
<h2><a class="toc-backref" href="#id3">Concurrency</a><a class="headerlink" href="#concurrency" title="Permalink to this headline">¶</a></h2>
<p>Throwing an exception in concurrent code (let&#8217;s assume we are using non-linked actors), will just simply blow up the thread that currently executes the actor.</p>
<ul class="simple">
<li>There is no way to find out that things went wrong (apart from inspecting the stack trace).</li>
<li>There is nothing you can do about it.</li>
</ul>
<p>Here actors provide a clean way of getting notification of the error and do something about it.</p>
<p>Linking actors also allow you to create sets of actors where you can be sure that either:</p>
<ul class="simple">
<li>All are dead</li>
<li>None are dead</li>
</ul>
<p>This is very useful when you have thousands of concurrent actors. Some actors might have implicit dependencies and together implement a service, computation, user session etc.</p>
<p>It encourages non-defensive programming. Don&#8217;t try to prevent things from go wrong, because they will, whether you want it or not. Instead; expect failure as a natural state in the life-cycle of your app, crash early and let someone else (that sees the whole picture), deal with it.</p>
</div>
<div class="section" id="distributed-actors">
<h2><a class="toc-backref" href="#id4">Distributed actors</a><a class="headerlink" href="#distributed-actors" title="Permalink to this headline">¶</a></h2>
<p>You can&#8217;t build a fault-tolerant system with just one single box - you need at least two. Also, you (usually) need to know if one box is down and/or the service you are talking to on the other box is down. Here actor supervision/linking is a critical tool for not only monitoring the health of remote services, but to actually manage the service, do something about the problem if the actor or node is down. Such as restarting actors on the same node or on another node.</p>
<p>In short, it is a very different way of thinking, but a way that is very useful (if not critical) to building fault-tolerant highly concurrent and distributed applications, which is as valid if you are writing applications for the JVM or the Erlang VM (the origin of the idea of &#8220;let-it-crash&#8221; and actor supervision).</p>
</div>
<div class="section" id="supervision">
<h2><a class="toc-backref" href="#id5">Supervision</a><a class="headerlink" href="#supervision" title="Permalink to this headline">¶</a></h2>
<p>Supervisor hierarchies originate from <a class="reference external" href="http://www.erlang.org/doc/design_principles/sup_princ.html#5">Erlang&#8217;s OTP framework</a>.</p>
<p>A supervisor is responsible for starting, stopping and monitoring its child processes. The basic idea of a supervisor is that it should keep its child processes alive by restarting them when necessary. This makes for a completely different view on how to write fault-tolerant servers. Instead of trying all things possible to prevent an error from happening, this approach embraces failure. It shifts the view to look at errors as something natural and something that <strong>will</strong> happen, instead of trying to prevent it; embraces it. Just &#8220;Let It Crash&#8221;, since the components will be reset to a stable state and restarted upon failure.</p>
<p>Akka has two different restart strategies; All-For-One and One-For-One. Best explained using some pictures (referenced from <a class="reference external" href="http://erlang.org">erlang.org</a> ):</p>
<div class="section" id="oneforone">
<h3><a class="toc-backref" href="#id6">OneForOne</a><a class="headerlink" href="#oneforone" title="Permalink to this headline">¶</a></h3>
<p>The OneForOne fault handler will restart only the component that has crashed.
<a class="reference external" href="image:http://www.erlang.org/doc/design_principles/sup4.gif">image:http://www.erlang.org/doc/design_principles/sup4.gif</a></p>
</div>
<div class="section" id="allforone">
<h3><a class="toc-backref" href="#id7">AllForOne</a><a class="headerlink" href="#allforone" title="Permalink to this headline">¶</a></h3>
<p>The AllForOne fault handler will restart all the components that the supervisor is managing, including the one that have crashed. This strategy should be used when you have a certain set of components that are coupled in some way that if one is crashing they all need to be reset to a stable state before continuing.
<a class="reference external" href="image:http://www.erlang.org/doc/design_principles/sup5.gif">image:http://www.erlang.org/doc/design_principles/sup5.gif</a></p>
</div>
<div class="section" id="restart-callbacks">
<h3><a class="toc-backref" href="#id8">Restart callbacks</a><a class="headerlink" href="#restart-callbacks" title="Permalink to this headline">¶</a></h3>
<p>There are two different callbacks that the Typed Actor and Actor can hook in to:</p>
<ul class="simple">
<li>Pre restart</li>
<li>Post restart</li>
</ul>
<p>These are called prior to and after the restart upon failure and can be used to clean up and reset/reinitialize state upon restart. This is important in order to reset the component failure and leave the component in a fresh and stable state before consuming further messages.</p>
</div>
<div class="section" id="defining-a-supervisor-s-restart-strategy">
<h3><a class="toc-backref" href="#id9">Defining a supervisor&#8217;s restart strategy</a><a class="headerlink" href="#defining-a-supervisor-s-restart-strategy" title="Permalink to this headline">¶</a></h3>
<p>Both the Typed Actor supervisor configuration and the Actor supervisor configuration take a &#8216;FaultHandlingStrategy&#8217; instance which defines the fault management. The different strategies are:</p>
<ul class="simple">
<li>AllForOne</li>
<li>OneForOne</li>
</ul>
<p>These have the semantics outlined in the section above.</p>
<p>Here is an example of how to define a restart strategy:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">AllForOneStrategy</span><span class="o">(</span> <span class="c1">//FaultHandlingStrategy; AllForOneStrategy or OneForOneStrategy</span>
  <span class="nc">List</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]),</span> <span class="c1">//What exceptions will be handled</span>
  <span class="mi">3</span><span class="o">,</span>           <span class="c1">// maximum number of restart retries</span>
  <span class="mi">5000</span>        <span class="c1">// within time in millis</span>
<span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="defining-actor-life-cycle">
<h3><a class="toc-backref" href="#id10">Defining actor life-cycle</a><a class="headerlink" href="#defining-actor-life-cycle" title="Permalink to this headline">¶</a></h3>
<p>The other common configuration element is the &#8220;LifeCycle&#8217; which defines the life-cycle. The supervised actor can define one of two different life-cycle configurations:</p>
<ul class="simple">
<li>Permanent: which means that the actor will always be restarted.</li>
<li>Temporary: which means that the actor will <strong>not</strong> be restarted, but it will be shut down through the regular shutdown process so the &#8216;postStop&#8217; callback function will called.</li>
</ul>
<p>Here is an example of how to define the life-cycle:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">Permanent</span> <span class="c1">// means that the component will always be restarted</span>
<span class="nc">Temporary</span> <span class="c1">// means that it will not be restarted, but it will be shut</span>
          <span class="c1">// down through the regular shutdown process so the &#39;postStop&#39; hook will called</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="supervising-actors">
<h2><a class="toc-backref" href="#id11">Supervising Actors</a><a class="headerlink" href="#supervising-actors" title="Permalink to this headline">¶</a></h2>
<div class="section" id="declarative-supervisor-configuration">
<h3><a class="toc-backref" href="#id12">Declarative supervisor configuration</a><a class="headerlink" href="#declarative-supervisor-configuration" title="Permalink to this headline">¶</a></h3>
<p>The Actor&#8217;s supervision can be declaratively defined by creating a &#8220;Supervisor&#8217; factory object. Here is an example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">supervisor</span> <span class="k">=</span> <span class="nc">Supervisor</span><span class="o">(</span>
  <span class="nc">SupervisorConfig</span><span class="o">(</span>
    <span class="nc">AllForOneStrategy</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]),</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">1000</span><span class="o">),</span>
    <span class="nc">Supervise</span><span class="o">(</span>
      <span class="n">actorOf</span><span class="o">[</span><span class="kt">MyActor1</span><span class="o">],</span>
      <span class="nc">Permanent</span><span class="o">)</span> <span class="o">::</span>
    <span class="nc">Supervise</span><span class="o">(</span>
      <span class="n">actorOf</span><span class="o">[</span><span class="kt">MyActor2</span><span class="o">],</span>
      <span class="nc">Permanent</span><span class="o">)</span> <span class="o">::</span>
    <span class="nc">Nil</span><span class="o">))</span>
</pre></div>
</div>
<p>Supervisors created like this are implicitly instantiated and started.</p>
<p>To configure a handler function for when the actor underlying the supervisor receives a MaximumNumberOfRestartsWithinTimeRangeReached message, you can specify a function of type
(ActorRef, MaximumNumberOfRestartsWithinTimeRangeReached) =&gt; Unit when creating the SupervisorConfig. This handler will be called with the ActorRef of the supervisor and the
MaximumNumberOfRestartsWithinTimeRangeReached message.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">handler</span> <span class="k">=</span> <span class="o">{</span>
  <span class="o">(</span><span class="n">supervisor</span><span class="k">:</span><span class="kt">ActorRef</span><span class="o">,</span><span class="n">max</span><span class="k">:</span><span class="kt">MaximumNumberOfRestartsWithinTimeRangeReached</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">EventHandler</span><span class="o">.</span><span class="n">notify</span><span class="o">(</span><span class="n">supervisor</span><span class="o">,</span><span class="n">max</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">supervisor</span> <span class="k">=</span> <span class="nc">Supervisor</span><span class="o">(</span>
  <span class="nc">SupervisorConfig</span><span class="o">(</span>
    <span class="nc">AllForOneStrategy</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]),</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">1000</span><span class="o">),</span>
    <span class="nc">Supervise</span><span class="o">(</span>
      <span class="n">actorOf</span><span class="o">[</span><span class="kt">MyActor1</span><span class="o">],</span>
      <span class="nc">Permanent</span><span class="o">)</span> <span class="o">::</span>
    <span class="nc">Supervise</span><span class="o">(</span>
      <span class="n">actorOf</span><span class="o">[</span><span class="kt">MyActor2</span><span class="o">],</span>
      <span class="nc">Permanent</span><span class="o">)</span> <span class="o">::</span>
    <span class="nc">Nil</span><span class="o">),</span> <span class="n">handler</span><span class="o">)</span>
</pre></div>
</div>
<p>You can link and unlink actors from a declaratively defined supervisor using the &#8216;link&#8217; and &#8216;unlink&#8217; methods:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">supervisor</span> <span class="k">=</span> <span class="nc">Supervisor</span><span class="o">(...)</span>
<span class="n">supervisor</span><span class="o">.</span><span class="n">link</span><span class="o">(..)</span>
<span class="n">supervisor</span><span class="o">.</span><span class="n">unlink</span><span class="o">(..)</span>
</pre></div>
</div>
<p>You can also create declarative supervisors through the &#8216;SupervisorFactory&#8217; factory object. Use this factory instead of the &#8216;Supervisor&#8217; factory object if you want to control instantiation and starting of the Supervisor, if not then it is easier and better to use the &#8216;Supervisor&#8217; factory object.</p>
<p>Example usage:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">factory</span> <span class="k">=</span> <span class="nc">SupervisorFactory</span><span class="o">(</span>
  <span class="nc">SupervisorConfig</span><span class="o">(</span>
    <span class="nc">OneForOneStrategy</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]),</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span>
    <span class="nc">Supervise</span><span class="o">(</span>
      <span class="n">myFirstActor</span><span class="o">,</span>
      <span class="nc">Permanent</span><span class="o">)</span> <span class="o">::</span>
    <span class="nc">Supervise</span><span class="o">(</span>
      <span class="n">mySecondActor</span><span class="o">,</span>
      <span class="nc">Permanent</span><span class="o">)</span> <span class="o">::</span>
    <span class="nc">Nil</span><span class="o">))</span>
</pre></div>
</div>
<p>Then create a new instance our Supervisor and start it up explicitly.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">supervisor</span> <span class="k">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">newInstance</span>
<span class="n">supervisor</span><span class="o">.</span><span class="n">start</span> <span class="c1">// start up all managed servers</span>
</pre></div>
</div>
</div>
<div class="section" id="declaratively-define-actors-as-remote-services">
<h3><a class="toc-backref" href="#id13">Declaratively define actors as remote services</a><a class="headerlink" href="#declaratively-define-actors-as-remote-services" title="Permalink to this headline">¶</a></h3>
<p>You can declaratively define an actor to be available as a remote actor by specifying <strong>true</strong> for registerAsRemoteService.</p>
<p>Here is an example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">supervisor</span> <span class="k">=</span> <span class="nc">Supervisor</span><span class="o">(</span>
  <span class="nc">SupervisorConfig</span><span class="o">(</span>
    <span class="nc">AllForOneStrategy</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]),</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">1000</span><span class="o">),</span>
    <span class="nc">Supervise</span><span class="o">(</span>
      <span class="n">actorOf</span><span class="o">[</span><span class="kt">MyActor1</span><span class="o">],</span>
      <span class="nc">Permanent</span><span class="o">,</span>
      <span class="o">**</span><span class="kc">true</span><span class="o">**)</span>
    <span class="o">::</span> <span class="nc">Nil</span><span class="o">))</span>
</pre></div>
</div>
</div>
<div class="section" id="programmatic-linking-and-supervision-of-actors">
<h3><a class="toc-backref" href="#id14">Programmatic linking and supervision of Actors</a><a class="headerlink" href="#programmatic-linking-and-supervision-of-actors" title="Permalink to this headline">¶</a></h3>
<p>Actors can at runtime create, spawn, link and supervise other actors. Linking and unlinking is done using one of the &#8216;link&#8217; and &#8216;unlink&#8217; methods available in the &#8216;ActorRef&#8217; (therefore prefixed with &#8216;self&#8217; in these examples).</p>
<p>Here is the API and how to use it from within an &#8216;Actor&#8217;:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="c1">// link and unlink actors</span>
<span class="n">self</span><span class="o">.</span><span class="n">link</span><span class="o">(</span><span class="n">actorRef</span><span class="o">)</span>
<span class="n">self</span><span class="o">.</span><span class="n">unlink</span><span class="o">(</span><span class="n">actorRef</span><span class="o">)</span>

<span class="c1">// starts and links Actors atomically</span>
<span class="n">self</span><span class="o">.</span><span class="n">startLink</span><span class="o">(</span><span class="n">actorRef</span><span class="o">)</span>

<span class="c1">// spawns (creates and starts) actors</span>
<span class="n">self</span><span class="o">.</span><span class="n">spawn</span><span class="o">[</span><span class="kt">MyActor</span><span class="o">]</span>
<span class="n">self</span><span class="o">.</span><span class="n">spawnRemote</span><span class="o">[</span><span class="kt">MyActor</span><span class="o">]</span>

<span class="c1">// spawns and links Actors atomically</span>
<span class="n">self</span><span class="o">.</span><span class="n">spawnLink</span><span class="o">[</span><span class="kt">MyActor</span><span class="o">]</span>
<span class="n">self</span><span class="o">.</span><span class="n">spawnLinkRemote</span><span class="o">[</span><span class="kt">MyActor</span><span class="o">]</span>
</pre></div>
</div>
<p>A child actor can tell the supervising actor to unlink him by sending him the &#8216;Unlink(this)&#8217; message. When the supervisor receives the message he will unlink and shut down the child. The supervisor for an actor is available in the &#8216;supervisor: Option[Actor]&#8217; method in the &#8216;ActorRef&#8217; class. Here is how it can be used.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">if</span> <span class="o">(</span><span class="n">supervisor</span><span class="o">.</span><span class="n">isDefined</span><span class="o">)</span> <span class="n">supervisor</span><span class="o">.</span><span class="n">get</span> <span class="o">!</span> <span class="nc">Unlink</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>

<span class="c1">// Or shorter using &#39;foreach&#39;:</span>

<span class="n">supervisor</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="k">_</span> <span class="o">!</span> <span class="nc">Unlink</span><span class="o">(</span><span class="n">self</span><span class="o">))</span>
</pre></div>
</div>
</div>
<div class="section" id="the-supervising-actor-s-side-of-things">
<h3><a class="toc-backref" href="#id15">The supervising actor&#8217;s side of things</a><a class="headerlink" href="#the-supervising-actor-s-side-of-things" title="Permalink to this headline">¶</a></h3>
<p>If a linked Actor is failing and throws an exception then an &#8220;Exit(deadActor, cause)&#8217; message will be sent to the supervisor (however you should never try to catch this message in your own message handler, it is managed by the runtime).</p>
<p>The supervising Actor also needs to define a fault handler that defines the restart strategy the Actor should accommodate when it traps an &#8220;Exit&#8217; message. This is done by setting the &#8220;faultHandler&#8217; field.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">protected</span> <span class="k">var</span> <span class="n">faultHandler</span><span class="k">:</span> <span class="kt">FaultHandlingStrategy</span>
</pre></div>
</div>
<p>The different options are:</p>
<ul class="simple">
<li>AllForOneStrategy(trapExit, maxNrOfRetries, withinTimeRange)<ul>
<li>trapExit is a List or Array of classes inheriting from Throwable, they signal which types of exceptions this actor will handle</li>
</ul>
</li>
<li>OneForOneStrategy(trapExit, maxNrOfRetries, withinTimeRange)<ul>
<li>trapExit is a List or Array of classes inheriting from Throwable, they signal which types of exceptions this actor will handle</li>
</ul>
</li>
</ul>
<p>Here is an example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">self</span><span class="o">.</span><span class="n">faultHandler</span> <span class="k">=</span> <span class="nc">AllForOneStrategy</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Throwable</span><span class="o">]),</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">1000</span><span class="o">)</span>
</pre></div>
</div>
<p>Putting all this together it can look something like this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MySupervisor</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="n">self</span><span class="o">.</span><span class="n">faultHandler</span> <span class="k">=</span> <span class="nc">OneForOneStrategy</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Throwable</span><span class="o">]),</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">5000</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Register</span><span class="o">(</span><span class="n">actor</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">self</span><span class="o">.</span><span class="n">link</span><span class="o">(</span><span class="n">actor</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>You can also link an actor from outside the supervisor like this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">supervisor</span> <span class="k">=</span> <span class="nc">Actor</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">actorsFor</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">MySupervisor</span><span class="o">]).</span><span class="n">head</span>
<span class="n">supervisor</span><span class="o">.</span><span class="n">link</span><span class="o">(</span><span class="n">actor</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="the-supervised-actor-s-side-of-things">
<h3><a class="toc-backref" href="#id16">The supervised actor&#8217;s side of things</a><a class="headerlink" href="#the-supervised-actor-s-side-of-things" title="Permalink to this headline">¶</a></h3>
<p>The supervised actor needs to define a life-cycle. This is done by setting the lifeCycle field as follows:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">self</span><span class="o">.</span><span class="n">lifeCycle</span> <span class="k">=</span> <span class="nc">Permanent</span> <span class="c1">// Permanent or Temporary or UndefinedLifeCycle</span>
</pre></div>
</div>
<p>In the supervised Actor you can override the &#8220;preRestart&#8217; and &#8220;postRestart&#8217; callback methods to add hooks into the restart process. These methods take the reason for the failure, e.g. the exception that caused termination and restart of the actor as argument. It is in these methods that <strong>you</strong> have to add code to do cleanup before termination and initialization after restart. Here is an example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">class</span> <span class="nc">FaultTolerantService</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">preRestart</span><span class="o">(</span><span class="n">reason</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span> <span class="c1">// clean up before restart</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">postRestart</span><span class="o">(</span><span class="n">reason</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span> <span class="c1">// reinit stable state after restart</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="reply-to-initial-senders">
<h3><a class="toc-backref" href="#id17">Reply to initial senders</a><a class="headerlink" href="#reply-to-initial-senders" title="Permalink to this headline">¶</a></h3>
<p>Supervised actors have the option to reply to the initial sender within preRestart, postRestart and postStop. A reply within these methods is possible after receive has thrown an exception. When receive returns normally it is expected that any necessary reply has already been done within receive. Here&#8217;s an example.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">class</span> <span class="nc">FaultTolerantService</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">msg</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="c1">// do something that may throw an exception</span>
      <span class="c1">// ...</span>

      <span class="n">self</span><span class="o">.</span><span class="n">reply</span><span class="o">(</span><span class="s">&quot;ok&quot;</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">preRestart</span><span class="o">(</span><span class="n">reason</span><span class="k">:</span> <span class="kt">scala.Throwable</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">self</span><span class="o">.</span><span class="n">tryReply</span><span class="o">(</span><span class="n">reason</span><span class="o">.</span><span class="n">getMessage</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">postStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">self</span><span class="o">.</span><span class="n">tryReply</span><span class="o">(</span><span class="s">&quot;stopped by supervisor&quot;</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<ul class="simple">
<li>A reply within preRestart or postRestart must be a try reply via <cite>self.tryReply</cite> because an self.reply will throw an exception when the actor is restarted without having failed. This can be the case in context of AllForOne restart strategies.</li>
<li>A reply within postStop must be a reply via <cite>self.tryReply</cite> because an self.reply will throw an exception when the actor has been stopped by the application (and not by a supervisor) after successful execution of receive (or no execution at all).</li>
</ul>
</div>
<div class="section" id="handling-too-many-actor-restarts-within-a-specific-time-limit">
<h3><a class="toc-backref" href="#id18">Handling too many actor restarts within a specific time limit</a><a class="headerlink" href="#handling-too-many-actor-restarts-within-a-specific-time-limit" title="Permalink to this headline">¶</a></h3>
<p>If you remember, when you define the &#8216;RestartStrategy&#8217; you also defined maximum number of restart retries within time in millis.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">AllForOneStrategy</span><span class="o">(</span> <span class="c1">//Restart policy, AllForOneStrategy or OneForOneStrategy</span>
  <span class="nc">List</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]),</span> <span class="c1">//What kinds of exception it will handle</span>
  <span class="mi">3</span><span class="o">,</span>           <span class="c1">// maximum number of restart retries</span>
  <span class="mi">5000</span>         <span class="c1">// within time in millis</span>
<span class="o">)</span>
</pre></div>
</div>
<p>Now, what happens if this limit is reached?</p>
<p>What will happen is that the failing actor will send a system message to its supervisor called &#8216;MaximumNumberOfRestartsWithinTimeRangeReached&#8217; with the following signature:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">MaximumNumberOfRestartsWithinTimeRangeReached</span><span class="o">(</span>
  <span class="n">victim</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">maxNrOfRetries</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">withinTimeRange</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">lastExceptionCausingRestart</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span>
</pre></div>
</div>
<p>If you want to be able to take action upon this event (highly recommended) then you have to create a message handle for it in the supervisor.</p>
<p>Here is an example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">supervisor</span> <span class="k">=</span> <span class="n">actorOf</span><span class="o">(</span><span class="k">new</span> <span class="nc">Actor</span><span class="o">{</span>
  <span class="n">self</span><span class="o">.</span><span class="n">faultHandler</span> <span class="k">=</span> <span class="nc">OneForOneStrategy</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Throwable</span><span class="o">]),</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">5000</span><span class="o">)</span>
  <span class="k">protected</span> <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">MaximumNumberOfRestartsWithinTimeRangeReached</span><span class="o">(</span>
      <span class="n">victimActorRef</span><span class="o">,</span> <span class="n">maxNrOfRetries</span><span class="o">,</span> <span class="n">withinTimeRange</span><span class="o">,</span> <span class="n">lastExceptionCausingRestart</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="o">...</span> <span class="c1">// handle the error situation</span>
  <span class="o">}</span>
<span class="o">}).</span><span class="n">start</span><span class="o">()</span>
</pre></div>
</div>
<p>You will also get this log warning similar to this:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">WAR [20100715-14:05:25.821] actor: Maximum number of restarts [5] within time range [5000] reached.</span>
<span class="go">WAR [20100715-14:05:25.821] actor:     Will *not* restart actor [Actor[akka.actor.SupervisorHierarchySpec$CountDownActor:1279195525812]] anymore.</span>
<span class="go">WAR [20100715-14:05:25.821] actor:     Last exception causing restart was [akka.actor.SupervisorHierarchySpec$FireWorkerException: Fire the worker!].</span>
</pre></div>
</div>
<p>If you don&#8217;t define a message handler for this message then you don&#8217;t get an error but the message is simply not sent to the supervisor. Instead you will get a log warning.</p>
</div>
</div>
<div class="section" id="supervising-typed-actors">
<h2><a class="toc-backref" href="#id19">Supervising Typed Actors</a><a class="headerlink" href="#supervising-typed-actors" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id20">Declarative supervisor configuration</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>To configure Typed Actors for supervision you have to consult the &#8220;TypedActorConfigurator&#8217; and its &#8220;configure&#8217; method. This method takes a &#8220;RestartStrategy&#8217; and an array of &#8220;Component&#8217; definitions defining the Typed Actors and their &#8220;LifeCycle&#8217;. Finally you call the &#8220;supervise&#8217; method to start everything up. The configuration elements reside in the &#8220;akka.config.JavaConfig&#8217; class and need to be imported statically.</p>
<p>Here is an example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.config.Supervision._</span>

<span class="k">val</span> <span class="n">manager</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">TypedActorConfigurator</span>

<span class="n">manager</span><span class="o">.</span><span class="n">configure</span><span class="o">(</span>
  <span class="nc">AllForOneStrategy</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]),</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">1000</span><span class="o">),</span>
    <span class="nc">List</span><span class="o">(</span>
      <span class="nc">SuperviseTypedActor</span><span class="o">(</span>
        <span class="nc">Foo</span><span class="o">.</span><span class="n">class</span><span class="o">,</span>
        <span class="nc">FooImpl</span><span class="o">.</span><span class="n">class</span><span class="o">,</span>
        <span class="nc">Permanent</span><span class="o">,</span>
        <span class="mi">1000</span><span class="o">),</span>
      <span class="k">new</span> <span class="nc">SuperviseTypedActor</span><span class="o">(</span>
        <span class="nc">Bar</span><span class="o">.</span><span class="n">class</span><span class="o">,</span>
        <span class="nc">BarImpl</span><span class="o">.</span><span class="n">class</span><span class="o">,</span>
        <span class="nc">Permanent</span><span class="o">,</span>
        <span class="mi">1000</span><span class="o">)</span>
  <span class="o">)).</span><span class="n">supervise</span>
</pre></div>
</div>
<p>Then you can retrieve the Typed Actor as follows:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">Foo</span> <span class="n">foo</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="n">Foo</span><span class="o">])</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id21">Restart callbacks</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="programatic-linking-and-supervision-of-typedactors">
<h3><a class="toc-backref" href="#id22">Programatic linking and supervision of TypedActors</a><a class="headerlink" href="#programatic-linking-and-supervision-of-typedactors" title="Permalink to this headline">¶</a></h3>
<p>TypedActors can be linked and unlinked just like actors - in fact the linking is done on the underlying actor:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">TypedActor</span><span class="o">.</span><span class="n">link</span><span class="o">(</span><span class="n">supervisor</span><span class="o">,</span> <span class="n">supervised</span><span class="o">)</span>

<span class="nc">TypedActor</span><span class="o">.</span><span class="n">unlink</span><span class="o">(</span><span class="n">supervisor</span><span class="o">,</span> <span class="n">supervised</span><span class="o">)</span>
</pre></div>
</div>
<p>If the parent TypedActor (supervisor) wants to be able to do handle failing child TypedActors, e.g. be able restart the linked TypedActor according to a given fault handling scheme then it has to set its &#8216;trapExit&#8217; flag to an array of Exceptions that it wants to be able to trap:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">TypedActor</span><span class="o">.</span><span class="n">faultHandler</span><span class="o">(</span><span class="n">supervisor</span><span class="o">,</span> <span class="nc">AllForOneStrategy</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">IOException</span><span class="o">]),</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">2000</span><span class="o">))</span>
</pre></div>
</div>
<p>For convenience there is an overloaded link that takes trapExit and faultHandler for the supervisor as arguments. Here is an example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.actor.TypedActor._</span>

<span class="k">val</span> <span class="n">foo</span> <span class="k">=</span> <span class="n">newInstance</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Foo</span><span class="o">],</span> <span class="mi">1000</span><span class="o">)</span>
<span class="k">val</span> <span class="n">bar</span> <span class="k">=</span> <span class="n">newInstance</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Bar</span><span class="o">],</span> <span class="mi">1000</span><span class="o">)</span>

<span class="n">link</span><span class="o">(</span><span class="n">foo</span><span class="o">,</span> <span class="n">bar</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AllForOneStrategy</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">IOException</span><span class="o">]),</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">2000</span><span class="o">))</span>

<span class="c1">// alternative: chaining</span>
<span class="n">bar</span> <span class="k">=</span> <span class="n">faultHandler</span><span class="o">(</span><span class="n">foo</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AllForOneStrategy</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">IOException</span><span class="o">]),</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">2000</span><span class="o">))</span>
  <span class="o">.</span><span class="n">newInstance</span><span class="o">(</span><span class="nc">Bar</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="mi">1000</span><span class="o">)</span>

<span class="n">link</span><span class="o">(</span><span class="n">foo</span><span class="o">,</span> <span class="n">bar</span>
</pre></div>
</div>
</div>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="serialization.html">Serialization (Scala)</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="dispatchers.html">Dispatchers (Scala)</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2011, Typesafe Inc.
      Last updated on Sep 19, 2011.
    </div>
  </body>
</html>